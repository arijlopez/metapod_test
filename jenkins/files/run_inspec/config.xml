<?xml version='1.1' encoding='UTF-8'?>
<flow-definition plugin="workflow-job@2.40">
  <actions>
    <org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobAction plugin="pipeline-model-definition@1.7.2"/>
    <org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobPropertyTrackerAction plugin="pipeline-model-definition@1.7.2">
      <jobProperties/>
      <triggers/>
      <parameters/>
      <options/>
    </org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobPropertyTrackerAction>
  </actions>
  <description></description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <jenkins.model.BuildDiscarderProperty>
      <strategy class="hudson.tasks.LogRotator">
        <daysToKeep>-1</daysToKeep>
        <numToKeep>-1</numToKeep>
        <artifactDaysToKeep>-1</artifactDaysToKeep>
        <artifactNumToKeep>-1</artifactNumToKeep>
      </strategy>
    </jenkins.model.BuildDiscarderProperty>
    <hudson.model.ParametersDefinitionProperty>
      <parameterDefinitions>
        <hudson.model.StringParameterDefinition>
          <name>report_name</name>
          <description></description>
          <defaultValue>inspec_report</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>ssh_key_name</name>
          <description></description>
          <defaultValue>csdd_rakuten_vms</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>remote_user</name>
          <description></description>
          <defaultValue>csdd-automation</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.TextParameterDefinition>
          <name>remote_hosts</name>
          <description></description>
          <defaultValue></defaultValue>
          <trim>false</trim>
        </hudson.model.TextParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>uuid</name>
          <description></description>
          <defaultValue></defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>reports_location</name>
          <description></description>
          <defaultValue>/data/reports</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>repo_name</name>
          <description></description>
          <defaultValue>profiles</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>inspec_profile</name>
          <description></description>
          <defaultValue></defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>arguments</name>
          <description></description>
          <defaultValue></defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
      </parameterDefinitions>
    </hudson.model.ParametersDefinitionProperty>
  </properties>
  <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@2.87">
    <script>// convert remote_hosts to a list
def SERVERS = Eval.me(params.remote_hosts)
def INSPEC_PROFILE = Eval.me(params.inspec_profile)
//println &quot;the inspec profile: &quot; +  INSPEC_PROFILE[0]

//it will be possible to use a dictionary parameter
//def _arguments = readJSON text: params.arguments

pipeline {
agent any
environment {
    REPOS_PRIVATE_KEY = credentials(&quot;metapod_private_key&quot;)
}
stages {
    stage(&quot;clear workspace&quot;) {
        steps {
        sh &apos;echo removing workspace&apos;
        sh &apos;rm -rf ${WORKSPACE}/*&apos;
        //sh &quot;echo printing parameters:&quot;
        //sh &quot;echo report_name: $report_name&quot;
        //sh &quot;echo ssh_key_name: $ssh_key_name&quot;
        //sh &quot;echo remote_user: $remote_user&quot;
        //sh &quot;echo remote_hosts: $SERVERS&quot;
        //sh &quot;echo reports_location: $reports_location&quot;
        //sh &quot;echo repon_name: $repo_name&quot;
        //sh &quot;echo inspec_profile: $inspec_profile&quot;
        //sh &quot;echo uuid: $uuid&quot;

        }
    }
    stage(&quot;Get ready workspace&quot;) {
        steps {
        sh &apos;mkdir -p ${WORKSPACE}/${uuid}&apos;
        }
    }
    stage(&quot;Clone repository&quot;) {
        steps {
        script {
            if (INSPEC_PROFILE[0] == &quot;csdd&quot;) {
              sh &apos;eval `ssh-agent -s` &amp;&amp; ssh-add $REPOS_PRIVATE_KEY &amp;&amp; GIT_SSH_COMMAND=&quot;ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no&quot; git clone ssh://git@git.rakuten-it.com:7999/csddaut/security-test-profiles.git \$WORKSPACE/$repo_name --recursive || true &amp;&amp; kill -15 $(echo \$SSH_AGENT_PID)&apos;
              def dirExists = fileExists (&quot;$WORKSPACE/$repo_name&quot;)
              if (dirExists) {
                print &quot;Profile repository successfully created in $WORKSPACE/$repo_name&quot;
                } else {
                print &quot;There has been a problem, the profiles repository could not be created, exiting&quot;
                sh &apos;exit 1&apos;
                }
              } else {
                println &quot;Using external profile: &quot; + INSPEC_PROFILE[1]
              }
            }
        }
    }

    stage(&apos;Run Inspec&apos;) {
        steps {
            script {
                sh &apos;echo $WORKSPACE&apos;
                //def failedHosts = []
                // run inspec
                for (int i = 0; i &lt; SERVERS.size(); i++) {
                    //script {
                if (SERVERS[i][2] == &quot;password&quot;) {
                    SERVER_SECRET=&quot;metapod_private_key&quot;
                } else {
                    SERVER_SECRET=&quot;${SERVERS[i][3]}&quot;
                }
                //print &apos;THIS IS THE SERVER_SECRET=&apos; + SERVER_SECRET

                withCredentials([
                    sshUserPrivateKey(
                    credentialsId: &quot;${SERVER_SECRET}&quot;,
                    keyFileVariable: &apos;SERVER_KEY&apos;,
                    passphraseVariable: &apos;PASSPHRASE&apos;),
                ]) {
                        //print &apos;SERVER_KEY=&apos; + SERVER_KEY
                        //print &apos;PASSPHRASE=&apos; + PASSPHRASE

                        date_tag = java.time.LocalDate.now()
                        datetime_tag = java.time.LocalDateTime.now()
                        //def host_private_key = credentials(&quot;${params.ssh_key_name}&quot;)
                        //sh &quot;echo this is the date_tag ${date_tag}&quot;
                        //sh &quot;echo this is the datetime_tag ${datetime_tag}&quot;
                        //print &apos;THIS IS THE SERVER KEY=&apos; + SERVER_KEY
                        //print &apos;LIST_SIZE=&apos; + SERVERS[i].size()
                        try {
                            PASSPHRASE = PASSPHRASE
                            //print &quot;PASSPHRASE is True&quot;
                            PASSPHRASE_EXISTS = &quot;True&quot;
                        } catch (e) {
                            //print &quot;PASSPHRASE is False&quot;
                            PASSPHRASE_EXISTS = &quot;False&quot;
                        }
                        //println &quot;this is not equal debug, it equals: &quot; + INSPEC_PROFILE[0]
                            if (INSPEC_PROFILE[0] == &quot;csdd&quot;) {
                              profile_path = &quot;${WORKSPACE}/${repo_name}/cookbooks/audit_wrap/profiles/${INSPEC_PROFILE[1]}&quot;
                            }else {
                              profile_path = &quot;${INSPEC_PROFILE[1]}&quot;
                            }
                            if (SERVERS[i][2] == &quot;password&quot;) {
                                print &quot;Running Inspec with username and password&quot;
                                sh &quot;set +x &amp;&amp; eval `ssh-agent -s` &amp;&amp; inspec exec $profile_path --user ${SERVERS[i][1]} --password ${SERVERS[i][3]}  -t ssh://${SERVERS[i][0]} --log-level=error --reporter json:\$WORKSPACE/${uuid}/\${report_name}_${SERVERS[i][0]}_${datetime_tag}.json || true &amp;&amp; kill -15 \$(echo \$SSH_AGENT_PID)&quot;
                            } else if (SERVERS[i][2] == &quot;ssh_key_name&quot; &amp;&amp; PASSPHRASE_EXISTS == &quot;False&quot;) {
                                print &quot;Running Inspec with ssh key without passphrase&quot;
                                sh &quot;eval `ssh-agent -s` &amp;&amp; ssh-add $SERVER_KEY &amp;&amp; inspec exec $profile_path --user ${SERVERS[i][1]}  -t ssh://${SERVERS[i][0]} --log-level=error --reporter json:\$WORKSPACE/${uuid}/\${report_name}_${SERVERS[i][0]}_${datetime_tag}.json || true &amp;&amp; kill -15 \$(echo \$SSH_AGENT_PID)&quot;
                            }else {
                                print &quot;Running Inspec with ssh key with passphrase&quot;
                                sh &quot;echo &apos;#!/bin/sh&apos; &gt; ${WORKSPACE}/passphrase_${SERVERS[i][0]}.sh&quot;
                                sh &quot;echo &apos;echo $PASSPHRASE&apos; &gt;&gt; ${WORKSPACE}/passphrase_${SERVERS[i][0]}.sh&quot;
                                sh &quot;chmod +x ${WORKSPACE}/passphrase_${SERVERS[i][0]}.sh&quot;
                                // DISPLAY=1 SSH_ASKPASS=&quot;./${WORKSPACE}/passphrase_${SERVERS[i][0]}.sh&quot; ssh-add test_key &lt; /dev/null
                                sh &quot;eval `ssh-agent -s` &amp;&amp; DISPLAY=1 SSH_ASKPASS=\&quot;${WORKSPACE}/passphrase_${SERVERS[i][0]}.sh\&quot; ssh-add $SERVER_KEY &lt; /dev/null &amp;&amp; inspec exec $profile_path --user ${SERVERS[i][1]}  -t ssh://${SERVERS[i][0]} --log-level=error --reporter json:\$WORKSPACE/${uuid}/\${report_name}_${SERVERS[i][0]}_${datetime_tag}.json || true &amp;&amp; kill -15 \$(echo \$SSH_AGENT_PID)&quot;
                            }
                        // check that the reports have been succesfully generated, otherwise fail the build
                        // Add cli after --reporter like &quot;--reporter cli&quot; to log also on console
                        def exists = fileExists (&quot;${WORKSPACE}/${uuid}/${report_name}_${SERVERS[i][0]}_${datetime_tag}.json&quot;)
                        if (exists) {
                            echo &quot;Report was created successfully in ${WORKSPACE}/${uuid}/${report_name}_${SERVERS[i][0]}_${datetime_tag}.json&quot;
                        } else {
                            echo &quot;Inspec failed to create the report for host ${SERVERS[i][0]}&quot;
                            sh &quot;echo &apos;{ \&quot;${SERVERS[i][0]}\&quot;:\&quot;Failed\&quot; }&apos; &gt; ${WORKSPACE}/${uuid}/${report_name}_${SERVERS[i][0]}_${datetime_tag}.json&quot;

                        }
            }
                }
            }
        }
    }
}
 post {
        always {
            script {
            sh &apos;cp /var/jenkins_home/jobs/${JOB_NAME}/builds/${BUILD_NUMBER}/log ${WORKSPACE}/${uuid}&apos;
            sh &apos;mkdir ${reports_location}/${JOB_NAME}_${BUILD_NUMBER}&apos;
            sh &apos;cp -R ${WORKSPACE}/${uuid}/* ${reports_location}/${JOB_NAME}_${BUILD_NUMBER}&apos;
            }
        }
    }
}
</script>
    <sandbox>true</sandbox>
  </definition>
  <triggers/>
  <authToken>metapod</authToken>
  <disabled>false</disabled>
</flow-definition>